import{e as c,y as u,a as W,v as se,ao as We,aI as Be,b as Ne,bN as De,n as v,av as ze,ht as Ge,at as oe,aw as D,a2 as H,z as p,bb as Fe,U as Y,al as U,aQ as le,hu as ie,fb as ke,fc as Re,hv as ce,f9 as he,eI as G,aP as Ue,hw as J,g as M,hx as qe,aV as Qe,ai as Pe,fx as He,fU as je,eT as V,eM as Ve,eR as X,eN as ue,eU as Ke,b4 as Ye,hy as Je,j as z,hz as B,hA as Xe,hB as pe,Y as Ze,D as $e,l as A,am as et,aN as ee,aL as tt,t as Ee,bG as xe,h as st,s as it,C as Oe,aO as me,aF as at,aE as rt,aH as nt,q as ot,a4 as lt,_ as ct,B as ht}from"./index-c754ff65.js";import{e as ut,W as pt,n as S}from"./widget-7352089c.js";import{x as ae}from"./Basemap-11f6c81d.js";import{h as mt,L as dt}from"./basemapUtils-abd7da37.js";import{l as j,a as de}from"./ViewingMode-915d19cb.js";import{s as Le}from"./Util-f53b4bf3.js";import{R as ft}from"./Scheduler-68df8c73.js";import{u as K,b as gt,q as yt,c as bt}from"./aaBoundingRect-5c57438c.js";import{j as q,p as Q}from"./TileInfo-2589d4ff.js";import{n as wt}from"./Heading-adb0ad8a.js";import{t as _t}from"./accessibleHandler-b82b4bb4.js";import"./uuid-73213768.js";import"./loadAll-026b7227.js";import"./writeUtils-a7e8e976.js";import"./vec2f64-22afc56f.js";import"./TileKey-b87e0dc5.js";let vt=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},St=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new kt}},kt=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},Rt=class{constructor(e,s,i,a){this._workerFunc=e,this._callbackFunc=s,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=a.map(r=>new St(r))}destroy(){this._clients.length=0}hasQuota(e){const s=this._clients[e];return!!s&&(this._totalNumWorkers<this._maxTotalNumWorkers||s.numWorkers+s.tasks.length<s.typeWorkerQuota)}push(e){const s=this._clients[e.client];s&&(this._totalNumWorkers<this._maxTotalNumWorkers?(s.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,a)=>this._taskCallback(i,a))):s.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const s=this._clients[e.client];this._totalNumWorkers--,s.numWorkers--,s.statistics.requests++,s.statistics.size+=e.size||0,s.statistics.duration+=e.duration||0,s.statistics.speed=s.statistics.duration>0?s.statistics.size/s.statistics.duration:0,Le(s.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(s,i)=>this._taskCallback(s,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,s){e._cancelled||(this._callbackFunc(e,s),this._taskFinished(e))}getStatsForType(e){const s=this._clients[e];return s?{quota:s.typeWorkerQuota,workers:s.numWorkers,queueSize:s.tasks.length,requestStats:s.statistics}:null}get test(){const e=this;return{set workerFunc(s){e._workerFunc=s}}}},Z=class extends se{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,s,i){this._loadQueue=new Rt((a,r)=>this._startLoading(a,r),(a,r)=>this._doneLoadingCB(a,r),e,s),i&&(this._frameTask=i.registerTask(ft.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=We(this._frameTask),this._tasks.forEach(e=>Be(e.abortController)),this._loadQueue=Ne(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,s,i,a={}){const r=De();r.__signal=v(a)?a.signal:null;const n=this._createOrUpdateTask(e,s,i,a,r);return ze(a,()=>this._cancelRequest(n,r)),r.promise}_createTask(e,s,i,a,r,n){const o=new Ot(e,s,i,a,r);return this._updateTask(o,n),this._tasks.set(r,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,s){var i;Ge(e.resolvers,s),s.reject(oe()),e.resolvers.length===0&&(e.status===_.DOWNLOADING&&(e.status=_.CANCELLED,this._loadQueue.cancel(e),(i=e.abortController)==null||i.abort(),e.request=null,e.abortController=null),e.status=_.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,s){e.resolvers.push(s)}_createOrUpdateTask(e,s,i,a,r){const n=Lt(v(a)&&a.uid||e,s,i),o=this._tasks.get(n);return o?(this._updateTask(o,r),o):this._createTask(e,a,s,i,n,r)}_doneLoadingCB(e,s){this._loadQueue&&(Le(e.status===_.DOWNLOADING),e.status=_.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:s}):this._doneLoading(e,s))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const s=this._onLoadQueue.shift();D(s.task.abortController),s.task.abortController=null,s.callback(s.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const s=this._doneQueue.shift();s.task.status!==_.DOWNLOADED&&(s.err=s.err||oe()),this._doneLoading(s.task,s.err),e.madeProgress()}}_doneLoading(e,s){if(s&&!H(s)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const a of e.resolvers)if(s)H(s)?a.reject(s):a.reject(new p("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${s}`,{url:e.url,error:s}));else{--i;const r=i<=0?e.result:Fe(e.result);a.resolve(r)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,s){if(e.status===_.CANCELLED)return!1;let i,a;switch(e.startTime=performance.now(),e.status=_.DOWNLOADING,e.docType){case"binary":a="array-buffer",i=0;break;case"image":a="image";break;case"image+type":a="array-buffer";break;default:a="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=Y(e.url,{...e.options,responseType:a,timeout:i,signal:r});let n=()=>{};const o=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:s,task:e}):(e.abortController=null,s(e))},h=l=>{e.status===_.DOWNLOADING&&s(e,l),n()};return e.docType!=="image+type"?(e.request.then(l=>o(l.data),h),!0):(e.request.then(l=>{const m=l.data,f=Et(m);if(a="image",e.size=m.byteLength,f==="unknown")return e.request=Y(e.url,{responseType:a,timeout:i,signal:r}),void e.request.then(T=>o(T.data),h);const g=new Blob([m],{type:f}),E=window.URL.createObjectURL(g);n=()=>window.URL.revokeObjectURL(E),e.request=Y(E,{responseType:a,timeout:i,signal:r}),e.request.then(T=>o(new xt(T.data,f,n)),h)},h),!0)}get test(){return{loadQueue:this._loadQueue}}};c([u({readOnly:!0})],Z.prototype,"updating",void 0),Z=c([W("esri.views.3d.support.StreamDataLoader")],Z);const $t={numRetries:0};function Et(t){if(t.byteLength<2)return"unknown";const e=new Uint8Array(t,0,t.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let xt=class{constructor(e,s,i){this.image=e,this.type=s,this.release=i}get isOpaque(){return this.type==="image/jpeg"}};class Ot extends vt{constructor(e,s,i,a,r){super(a),this.url=e,this.options=s,this.docType=i,this.key=r,this.result=null,this.status=_.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=$t.numRetries}}function Lt(t,e,s){return`${t}:${e}:${s}`}var _;(function(t){t[t.QUEUED=1]="QUEUED",t[t.DOWNLOADING=2]="DOWNLOADING",t[t.DOWNLOADED=3]="DOWNLOADED",t[t.CANCELLED=4]="CANCELLED"})(_||(_={}));var fe,ge,$,ye,be,we,_e;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(fe||(fe={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(ge||(ge={})),function(t){t[t.NORTH=0]="NORTH",t[t.NORTH_EAST=1]="NORTH_EAST",t[t.EAST=2]="EAST",t[t.SOUTH_EAST=3]="SOUTH_EAST",t[t.SOUTH=4]="SOUTH",t[t.SOUTH_WEST=5]="SOUTH_WEST",t[t.WEST=6]="WEST",t[t.NORTH_WEST=7]="NORTH_WEST"}($||($={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(ye||(ye={})),function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.Water=3]="Water",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(be||(be={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}(we||(we={})),function(t){t[t.INSIDE=0]="INSIDE",t[t.INTERSECTS=1]="INTERSECTS",t[t.OUTSIDE=2]="OUTSIDE"}(_e||(_e={}));const It=12;class d{constructor(e){const s=d.checkUnsupported(e);if(v(s))throw s;const i=Pe(e);this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=ie(this.spatialReference)||ke(this.spatialReference)||Re(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const a=i.lods.reduce((l,m,f)=>(m.level<l.min&&(l.min=m.level,l.minIndex=f),l.max=Math.max(l.max,m.level),l),{min:1/0,minIndex:0,max:-1/0}),r=i.lods[a.minIndex],n=2**r.level;let o=r.resolution*n,h=r.scale*n;this.levels=new Array(a.max+1);for(let l=0;l<this.levels.length;l++)this.levels[l]={resolution:o,scale:h,tileSize:[o*i.size[0],o*i.size[1]]},o/=2,h/=2}clone(){return new d(this.toTileInfo())}toTileInfo(){return new q({dpi:this.dpi,origin:new U({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,s)=>new Q({level:s,scale:e.scale,resolution:e.resolution}))})}getExtent(e,s,i,a){const r=this.levels[e],n=r.tileSize[0],o=r.tileSize[1];a[0]=this.origin[0]+i*n,a[2]=this.origin[0]+(i+1)*n,a[3]=this.origin[1]-s*o,a[1]=this.origin[1]-(s+1)*o}convertExtentToRadians(e,s){this._isWebMercator?(s[0]=ce(e[0]),s[1]=he(e[1]),s[2]=ce(e[2]),s[3]=he(e[3])):this._isGCS&&(s[0]=G(e[0]),s[1]=G(e[1]),s[2]=G(e[2]),s[3]=G(e[3]))}getExtentGeometry(e,s,i,a=new Ue){return this.getExtent(e,s,i,k),a.spatialReference=this.spatialReference,a.xmin=k[0],a.ymin=k[1],a.xmax=k[2],a.ymax=k[3],a.zmin=void 0,a.zmax=void 0,a}ensureMaxLod(e){if(e==null)return!1;let s=!1;for(;this.levels.length<=e;){const i=this.levels[this.levels.length-1],a=i.resolution/2;this.levels.push({resolution:a,scale:i.scale/2,tileSize:[a*this.pixelSize,a*this.pixelSize]}),s=!0}return s}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const s=this.levels[0].scale;return e>=s?0:Math.log(s/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof d)){if(d.checkUnsupported(e))return!1;e=new d(e)}if(!e.spatialReference.equals(this.spatialReference)||e.pixelSize!==this.pixelSize)return!1;const s=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[s].resolution;let a=.5*i;return!J(e.origin[0],this.origin[0],a)||!J(e.origin[1],this.origin[1],a)?!1:(a=.5*i/2**s/this.pixelSize*It,J(i,e.levels[s].resolution,a))}rootTilesInExtent(e,s=null,i=1/0){const a=new Array,r=this.levels[0].tileSize;if(M(e)||r[0]===0||r[1]===0)return a;d.computeRowColExtent(e,r,this.origin,k);let n=k[1],o=k[3],h=k[0],l=k[2];const m=l-h,f=o-n;if(m*f>i){const g=Math.floor(Math.sqrt(i));f>g&&(n=n+Math.floor(.5*f)-Math.floor(.5*g),o=n+g),m>g&&(h=h+Math.floor(.5*m)-Math.floor(.5*g),l=h+g)}for(let g=n;g<o;g++)for(let E=h;E<l;E++)a.push([0,g,E]);return v(s)&&(s[0]=this.origin[0]+h*r[0],s[1]=this.origin[1]-o*r[1],s[2]=this.origin[0]+l*r[0],s[3]=this.origin[1]-n*r[1]),a}static computeRowColExtent(e,s,i,a){const r=.001*(e[2]-e[0]+(e[3]-e[1]));a[0]=Math.max(0,Math.floor((e[0]+r-i[0])/s[0])),a[2]=Math.max(0,Math.ceil((e[2]-r-i[0])/s[0])),a[1]=Math.max(0,Math.floor((i[1]-e[3]+r)/s[1])),a[3]=Math.max(0,Math.ceil((i[1]-e[1]-r)/s[1]))}static isPowerOfTwo(e){const s=e.lods,i=s[0].resolution*2**s[0].level;return!s.some(a=>!qe(a.resolution,i/2**a.level))}static hasGapInLevels(e){const s=e.lods.map(i=>i.level);s.sort((i,a)=>i-a);for(let i=1;i<s.length;i++)if(s[i]!==s[0]+i)return!0;return!1}static tileSizeSupported(e){const s=e.size[1];return s===e.size[0]&&(s&s-1)==0&&s>=128&&s<=512}static hasOriginPerLODs(e){const s=e.origin;return e.lods.some(i=>i.origin!=null&&(i.origin[0]!==s.x||i.origin[1]!==s.y))}static getMissingTileInfoError(){return new p("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return M(e)?re():e.lods.length<1?new p("tilingscheme:generic","Tiling scheme must have at least one level"):d.isPowerOfTwo(e)?d.hasGapInLevels(e)?new p("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):d.tileSizeSupported(e)?d.hasOriginPerLODs(e)?new p("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new p("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new p("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,s){const i=e[2]-e[0],a=e[3]-e[1],r=Qe(s),n=1.2*Math.max(i,a),o=256,h=96,l=.0254,m=new d(new q({size:[o,o],origin:new U({x:e[0]-.5*(n-i),y:e[3]+.5*(n-a)}),lods:[new Q({level:0,resolution:n/o,scale:1/(o/h*l/(n*r))})],spatialReference:s}));return m.ensureMaxLod(20),m}static makeWebMercatorAuxiliarySphere(e){const s=new d(d.WebMercatorAuxiliarySphereTileInfo);return s.ensureMaxLod(e),s}static makeGCSWithTileSize(e,s=256,i=16){const a=256/s,r=new d(new q({size:[s,s],origin:new U({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new Q({level:0,resolution:.703125*a,scale:295497598570834e-6*a})]}));return r.ensureMaxLod(i),r}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}function re(){return new p("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}d.WebMercatorAuxiliarySphereTileInfo=new q({size:[256,256],origin:new U({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:le.WebMercator}),spatialReference:le.WebMercator,lods:[new Q({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]}),d.WebMercatorAuxiliarySphere=d.makeWebMercatorAuxiliarySphere(19);const k=K(),ve=64;He(je/10);const Mt=K();d.WebMercatorAuxiliarySphere.getExtent(0,0,0,Mt);K([-180,-90,180,90]);const C=V(),At=V(),x=V(),O=V();function Tt(t,e,s=0){const i=t.extent;if(M(i))return!1;if(s===0)return gt(i,e);const a=Math.min(i[2]-i[0],i[3]-i[1]);return yt(i,e,s*a)}function F(t,e,s,i){Ve(C,s),C[i]=e[i];const a=X(C,C,e),r=X(At,t,e),n=ue(r,a),o=ue(a,a);let h;h=n<=0?e:o<=n?s:Ke(C,e,Ye(a,a,n/o));const l=X(C,t,h);return Math.PI/2-Math.atan(l[2]/Math.sqrt(l[0]*l[0]+l[1]*l[1]))}function Ct(t,e,s){const i=t.extent;if(M(i))return 0;x[0]=i[0],x[1]=i[1],x[2]=s,O[0]=i[2],O[1]=i[3],O[2]=s;let a=1/0,r=1/0;return e[0]<x[0]?a=F(e,x,O,0):e[0]>O[0]&&(a=F(e,O,x,0)),e[1]<x[1]?r=F(e,x,O,1):e[1]>O[1]&&(r=F(e,O,x,1)),Math.min(a,r)}function Wt(t,e,s){if(M(t))return re();if(t.spatialReference.isGeographic&&!ie(t.spatialReference))return new p("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const i=d.checkUnsupported(t);if(v(i))return i;if(M(s))return new p("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const a=Bt(t,s);if(a)return a;const r=t.spatialReference;return v(e)&&!(r.equals(e)||e.isWGS84&&r.isWebMercator)?new p("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function Bt(t,e){const s=t.lods,i=s[0].resolution*2**s[0].level,a=[i*t.size[0],i*t.size[1]],r=[t.origin.x,t.origin.y],n=bt(e),o=K();d.computeRowColExtent(n,a,r,o);const h=(o[2]-o[0])*(o[3]-o[1]);if(h>ve){const l=s[0].scale*2**s[0].level;let m=Math.max((n[3]-n[1])/t.size[1],(n[2]-n[0])/t.size[0])*l/i;const f=Math.floor(Math.log(m)/Math.log(10));return m=Math.ceil(m/10**f)*10**f,new p("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(l).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+m.toLocaleString()+".",{level0Scale:l,suggestedLevel0Scale:m,requiredNumRootTiles:h,allowedNumRootTiles:ve})}return null}const Nt=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:Wt,isInsideExtent:Tt,tiltToExtentEdge:Ct},Symbol.toStringTag,{value:"Module"}));function Dt(){return!0}function zt(){return 0}function Gt(t,e){if(M(t))return re();const s=t.lods.length-1,i=t.spatialReference,a=ie(i)||ke(i)||Re(i);if(i.isWebMercator){if(!d.makeWebMercatorAuxiliarySphere(s).compatibleWith(t))return new p("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!a)return new p("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!d.makeGCSWithTileSize(t.spatialReference,t.size[0],s).compatibleWith(t))return t.spatialReference.isWGS84?new p("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new p("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return v(e)&&!t.spatialReference.equals(e)?new p("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const Ft=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:Gt,isInsideExtent:Dt,tiltToExtentEdge:zt},Symbol.toStringTag,{value:"Module"})),Ut={[j.Global]:Ft,[j.Local]:Nt};function te(t,e,s,i){return Ut[i].checkIfTileInfoSupportedForViewSR(t,s,e)}function qt(t,e,s){const i=Je(t);if(v(i)){if(!z.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const a=i.find(r=>te(r.tileInfo,r.fullExtent,e,s)==null);if(a)return{tileInfo:a.tileInfo,fullExtent:a.fullExtent}}}return{tileInfo:null,fullExtent:null}}$.NORTH,$.EAST,$.SOUTH,$.WEST;$.NORTH_EAST,$.SOUTH_EAST,$.SOUTH_WEST,$.NORTH_WEST;function Qt(t,e){return t!=null&&(e==null||(e===j.Local?!t.isGeographic||t.isWGS84||t.wkid===B.CGCS2000:t.isWebMercator||t.isWGS84||t.wkid===B.CGCS2000||t.wkid===B.GCSMARS2000||t.wkid===B.GCSMARS2000_SPHERE||t.wkid===B.GCSMOON2000))}async function Pt(t,e={}){await jt(t,e),D(e)}async function Ht(t,e={}){var n;const{basemap:s,view:i}=t;if(D(e),"spatialReferenceLocked"in i&&!i.spatialReferenceLocked||(await s.load(e),D(e),s.baseLayers.length===0))return;const a=s.baseLayers.getItemAt(0);if(!Xe(a))return;if(s.spatialReference){if(i.spatialReference.equals(s.spatialReference))return;Se()}await a.load(e),D(e);const r=(("supportedSpatialReferences"in a?a.supportedSpatialReferences:null)||["tileInfo"in a?(n=a.tileInfo)==null?void 0:n.spatialReference:null]).filter(v);r.length!==0&&r.every(o=>!i.spatialReference.equals(o))&&Se()}function Se(){throw new p("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function jt(t,e){const{basemap:s,view:i}=t;if(await s.load(e),s.baseLayers.length===0)return;const a=s.baseLayers.concat(s.referenceLayers).toArray().filter(n=>!pe(n)).map(n=>new p("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:n,operationalLayerType:n.operationalLayerType||"unknown"}));if(a.length)throw a[0];const r=s.baseLayers.getItemAt(0);if(pe(r)){try{await r.load(e)}catch(n){const o="basemap-compatibility:unknown-error",h="Unknown basemap compatibility error",{name:l=o,message:m=h,details:f}=n;throw new p(l,m,f)}Vt(r,i)}}function Vt(t,e){const s=e.state.viewingMode;if(!s)return;let i,a;if((t==null?void 0:t.type)==="wmts"){const h=qt(t,e.spatialReference,s);if(M(h.tileInfo))throw new p("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");i=h.tileInfo,a=h.fullExtent}else i=t.tileInfo,a=t.fullExtent;if(M(i))return;if(!Qt(i.spatialReference,s))throw new p(`basemapgalleryitem:spatial-reference-unsupported-${de(s)}`,`Basemap spatial reference is unsupported in ${de(s)} mode`);const r=i.spatialReference.isGeographic,n=(t==null?void 0:t.type)==="vector-tile"?i.getOrCreateCompatible(256,r?1:2):null;if(s===j.Global){let h=te(i,a,null,s);if(h&&(t==null?void 0:t.type)==="vector-tile"&&v(a)&&n&&!te(n,a,null,s)&&(h=null),h){const l=i.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new p(`basemapgalleryitem:tiling-scheme-unsupported-${l}-global`,"Basemap tiling scheme is unsupported in global mode",{error:h})}}else if(d.checkUnsupported(i))throw new p("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const o=e.get("basemapTerrain.tilingScheme");if(o&&!o.compatibleWith(i)&&((t==null?void 0:t.type)!=="vector-tile"||!n||!o.compatibleWith(n)))throw new p("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}let R=class extends Ze($e(se)){constructor(e){super(e),this.compatibilityFunction=null,this.error=null,this.state="loading",this.view=null}initialize(){const e=()=>this.refresh();this.handles.add([A(()=>{var s;return(s=this.basemap)==null?void 0:s.loadStatus},e),A(()=>this.compatibilityFunction,e),A(()=>{var s;return this.view&&"basemapTerrain"in this.view&&((s=this.view.basemapTerrain)==null?void 0:s.tilingScheme)},e),A(()=>{var s;return(s=this.view)==null?void 0:s.ready},e),A(()=>{var s;return(s=this.view)==null?void 0:s.spatialReference},e)]),this.refresh()}destroy(){this._cancelRefresh(),this.basemap=null,this.compatibilityFunction=null,this.view=null}get _spatialReferenceTask(){return mt(this.view,this.basemap)}set basemap(e){const s=this._get("basemap");s&&s.cancelLoad(),e&&e.load().catch(()=>{}),this._set("basemap",e)}get spatialReference(){return this._spatialReferenceTask.spatialReference}refresh(){var a;this._cancelRefresh(),this._set("state","loading");const e=(a=this.basemap)==null?void 0:a.loadStatus;if(e!=="loaded"&&e!=="failed")return;if(!this.compatibilityFunction)return void(e==="loaded"?(this._set("state","ready"),this._set("error",null)):(this._set("state","error"),this._set("error",this.basemap.loadError)));const s=new AbortController,{signal:i}=s;this.compatibilityFunction(this,{signal:i}).then(()=>et(()=>!this._spatialReferenceTask.updating,i)).then(()=>{this._set("state","ready"),this._set("error",null)}).catch(r=>{H(r)||(this._set("state","error"),this._set("error",r))}),this._refreshController=s}_cancelRefresh(){this._refreshController&&(this._refreshController.abort(),this._refreshController=null)}};c([u({readOnly:!0})],R.prototype,"_spatialReferenceTask",null),c([u()],R.prototype,"basemap",null),c([u()],R.prototype,"compatibilityFunction",void 0),c([u({readOnly:!0})],R.prototype,"error",void 0),c([u({readOnly:!0})],R.prototype,"spatialReference",null),c([u({readOnly:!0})],R.prototype,"state",void 0),c([u()],R.prototype,"view",void 0),R=c([W("esri.widgets.BasemapGallery.support.BasemapGalleryItem")],R);const Ie=R,Me=z.ofType(ae);let N=class extends se{constructor(t){super(t),this.basemaps=new Me}get state(){return"ready"}refresh(){}};c([u({type:Me})],N.prototype,"basemaps",void 0),c([u({readOnly:!0})],N.prototype,"state",null),N=c([W("esri.widgets.BasemapGallery.support.LocalBasemapsSource")],N);const Ae=N,Te=z.ofType(ae);let I=class extends ee.LoadableMixin(tt(Ae)){constructor(t){super(t),this._handles=new Ee,this.basemaps=new Te,this.filterFunction=null,this.portal=xe.getDefault(),this.query=null,this.updateBasemapsCallback=null}initialize(){this._handles.add([A(()=>{var t,e;return[this.filterFunction,this.loadStatus,(t=this.portal)==null?void 0:t.basemapGalleryGroupQuery,(e=this.portal)==null?void 0:e.user,this.query,this.updateBasemapsCallback]},()=>this.refresh(),st)])}destroy(){this._handles.destroy(),this._handles=null,this.filterFunction=null,this.portal=null}get state(){return this.loadStatus==="not-loaded"?"not-loaded":this.loadStatus==="loading"||this._lastPortalBasemapFetchController?"loading":"ready"}load(t){return this.addResolvingPromise(this.portal.load(t)),this.notifyChange("state"),Promise.resolve(this)}async refresh(){if(this.state!=="ready")return;this._lastPortalBasemapFetchController&&(this._lastPortalBasemapFetchController.abort(),this._lastPortalBasemapFetchController=null);const t=this.portal,e=new AbortController;this._lastPortalBasemapFetchController=e,this.notifyChange("state");try{const s=await t.fetchBasemaps(this._toQueryString(this.query),e);this._updateBasemaps(s)}catch(s){if(H(s))throw s;it.getLogger(this.declaredClass).warn(new p("basemap-source:fetch-basemaps-error","Could not fetch basemaps from portal.",{error:s})),this._updateBasemaps()}this._lastPortalBasemapFetchController=null,this.notifyChange("state")}_toQueryString(t){return t&&typeof t!="string"?Object.keys(t).map(e=>`${e}:${t[e]}`).join(" AND "):t}_updateBasemaps(t=[]){let e=this.filterFunction?t.filter(this.filterFunction):t;e=this.updateBasemapsCallback?this.updateBasemapsCallback(e):e,this.basemaps.removeAll(),this.basemaps.addMany(e)}};c([u({readOnly:!0,type:Te})],I.prototype,"basemaps",void 0),c([u()],I.prototype,"filterFunction",void 0),c([u({type:xe})],I.prototype,"portal",void 0),c([u()],I.prototype,"query",void 0),c([u({readOnly:!0})],I.prototype,"state",null),c([u()],I.prototype,"updateBasemapsCallback",void 0),I=c([W("esri.widgets.BasemapGallery.support.PortalBasemapsSource")],I);const P=I,Ce=z.ofType(Ie);function Kt(t){return t&&t.declaredClass==="esri.portal.Portal"}function Yt(t){return t&&!(t instanceof P)&&(!!t.portal||!!t.query)}function Jt(t){return t&&"basemaps"in t&&"state"in t&&"refresh"in t}let w=class extends $e(ee){constructor(t){super(t),this._loadingProjectionEngine=!1,this.items=new Ce,this.source=new P,this.view=null}initialize(){const t=()=>this._recreateItems();this.handles.add([A(()=>this.state==="ready"?this.compatibilityFunction:null,()=>this._updateItems()),Oe(()=>{var e;return(e=this.source)==null?void 0:e.basemaps},"change",t,{onListenerAdd:t})])}get activeBasemap(){var t,e;return((e=(t=this.view)==null?void 0:t.map)==null?void 0:e.basemap)??null}set activeBasemap(t){var i,a;if(!this.view.map)return;const e=typeof t=="string"?ae.fromId(t):t;if(!e||!this.view.ready)return this.view.map.basemap=e,void this._clearOverride("activeBasemap");const s=e.spatialReference||((a=(i=this.items)==null?void 0:i.find(r=>this.basemapEquals(e,r.basemap)))==null?void 0:a.spatialReference);if(s&&"spatialReferenceLocked"in this.view&&!this.view.spatialReferenceLocked){const r=this.view.spatialReference;if(v(s)&&!me(r,s)&&!at(this.view.spatialReference,s)&&!rt())return this._override("activeBasemap",e),this._loadingProjectionEngine=!0,void nt().then(()=>{this._get("activeBasemap")===t&&(this.view.map.basemap=t,this.view.spatialReference=s,this._clearOverride("activeBasemap"))},()=>{}).then(()=>{this._loadingProjectionEngine=!1});this.view.map.basemap=e,this._clearOverride("activeBasemap"),v(s)&&!me(this.view.spatialReference,s)&&(this.view.spatialReference=s)}else this.view.map.basemap=e,this._clearOverride("activeBasemap")}get activeBasemapIndex(){const{state:t,items:e,activeBasemap:s}=this;if(t!=="ready")return-1;const i=e.findIndex(a=>a.basemap===s);return i===-1?e.findIndex(a=>this.basemapEquals(a.basemap,s)):i}get compatibilityFunction(){var t;return((t=this.view)==null?void 0:t.type)==="3d"?Pt:Ht}set compatibilityFunction(t){this._overrideIfSome("compatibilityFunction",t)}castSource(t){return Array.isArray(t)||z.isCollection(t)?new Ae({basemaps:t}):Kt(t)?new P({portal:t}):Yt(t)?new P(t):Jt(t)?t:null}get state(){var t;return(t=this.view)!=null&&t.ready&&this.source?this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(t,e){return dt(t,e)}refresh(){this._recreateItems()}load(t){return this.addResolvingPromise(ee.isLoadable(this.source)?this.source.load(t):null),Promise.resolve(this)}_recreateItems(){var i;const t=(i=this.source)==null?void 0:i.basemaps,{view:e,compatibilityFunction:s}=this;this.items.removeAll().forEach(a=>a.destroy()),t&&this.items.addMany(t.map(a=>new Ie({basemap:a,compatibilityFunction:s,view:e})))}_updateItems(){for(const t of this.items)t.compatibilityFunction=this.compatibilityFunction,t.view=this.view}};c([u()],w.prototype,"_loadingProjectionEngine",void 0),c([u()],w.prototype,"activeBasemap",null),c([u({readOnly:!0})],w.prototype,"activeBasemapIndex",null),c([u()],w.prototype,"compatibilityFunction",null),c([u({readOnly:!0,type:Ce})],w.prototype,"items",void 0),c([u()],w.prototype,"source",void 0),c([ot("source")],w.prototype,"castSource",null),c([u({readOnly:!0})],w.prototype,"state",null),c([u()],w.prototype,"view",void 0),w=c([W("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],w);const Xt=w,L="esri-basemap-gallery",y={base:`${L} esri-widget esri-widget--panel-height-only`,sourceLoading:`${L}--source-loading`,loader:`${L}__loader`,item:`${L}__item`,itemContainer:`${L}__item-container`,itemTitle:`${L}__item-title`,itemThumbnail:`${L}__item-thumbnail`,selectedItem:`${L}__item--selected`,itemError:`${L}__item--error`,emptyMessage:"esri-widget__content--empty",widgetIcon:"esri-icon-basemap",disabled:"esri-disabled",loaderAnimation:"esri-widget__loader-animation"};let b=class extends pt{constructor(t,e){super(t,e),this._handles=new Ee,this._focusBasemapItemEnabled=!1,this.disabled=!1,this.headingLevel=2,this.iconClass=y.widgetIcon,this.messages=null,this.viewModel=new Xt}initialize(){const t=this._handles;this.addHandles([Oe(()=>this.viewModel.items,"change",e=>{const s="basemap-gallery-item-changes",{added:i,moved:a}=e;t.remove(s),t.add([...i,...a].map(r=>A(()=>r.state,()=>this.scheduleRender())),s),this.scheduleRender()}),lt(()=>this.source,()=>this.viewModel.load(),{initial:!0,once:!0})])}destroy(){this._handles.destroy()}loadDependencies(){return ct(()=>import("./calcite-scrim-34e0e14a.js"),["assets/calcite-scrim-34e0e14a.js","assets/scrim-f0f62705.js","assets/widget-7352089c.js","assets/index-c754ff65.js","assets/index-252dcfb5.css","assets/uuid-73213768.js","assets/t9n-5ae2ba76.js","assets/observers-4f67f1fb.js","assets/loader-5ac824ac.js","assets/guid-9426053f.js"])}get activeBasemap(){return this.viewModel.activeBasemap}set activeBasemap(t){this.viewModel.activeBasemap=t}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}get source(){return this.viewModel.source}set source(t){this.viewModel.source=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}render(){const t=this.source.state==="loading",e=this.disabled||this.viewModel.state==="disabled",s=this.viewModel.items.map((n,o)=>this._renderBasemapGalleryItem(n,o)).toArray(),i={[y.sourceLoading]:t,[y.disabled]:e},a=t?S("div",{class:y.loader,key:"esri-basemap-gallery__loader"}):null,r=t?null:s.length>0?S("ul",{bind:this,"aria-disabled":this.disabled,"aria-label":this.label,class:y.itemContainer,key:"esri-basemap-gallery__item-container",onkeydown:this._handleKeyDown,role:"radiogroup"},s):S("div",{class:y.emptyMessage,key:"esri-basemap-gallery__empty-message"},S(wt,{level:this.headingLevel},this.messages.noBasemaps));return S("div",{class:this.classes(y.base,i)},a,r)}_getRoundRobinIndex(t,e){return(t+e)%e}_handleKeyDown(t){const{key:e}=t;if(!["ArrowUp","ArrowDown","ArrowRight","ArrowLeft"].includes(e))return;t.preventDefault();const{items:s,activeBasemapIndex:i}=this.viewModel,a=e==="ArrowUp"||e==="ArrowLeft"?this._getRoundRobinIndex(Math.max(i-1,-1),s.length):this._getRoundRobinIndex(i+1,s.length),r=s.getItemAt(a);(r==null?void 0:r.state)==="ready"&&(this.viewModel.activeBasemap=r.basemap),this._focusBasemapItemEnabled=!0}_focusBasemapItem(t){this._focusBasemapItemEnabled&&t.tabIndex===0&&(t.focus(),this._focusBasemapItemEnabled=!1)}_handleClick(t){const e=t.currentTarget["data-item"];e.state==="ready"&&(this.viewModel.activeBasemap=e.basemap)}_renderBasemapGalleryItem(t,e){var T,ne;const s=t.basemap.thumbnailUrl||ht("esri/themes/base/images/basemap-toggle-64.svg"),i=t.basemap.title,a=(T=t.basemap.portalItem)==null?void 0:T.snippet,r=((ne=t.error)==null?void 0:ne.message)||a||i,{viewModel:{state:n,activeBasemapIndex:o}}=this,h=this.disabled||n==="disabled",l=o===e,m=l||o===-1&&e===0?0:-1,f=n==="loading",g={[y.selectedItem]:l,[y.itemError]:t.state==="error"},E=`basemapgallery-item-${t.uid}`;return S("li",{"aria-checked":l.toString(),"aria-disabled":h.toString(),"aria-labelledby":E,bind:this,class:this.classes(y.item,g),"data-item":t,onkeydown:this._handleClick,onclick:this._handleClick,role:"radio",tabIndex:m,afterUpdate:this._focusBasemapItem,title:r},S("img",{alt:"",class:y.itemThumbnail,src:s}),S("div",{id:E,class:y.itemTitle},i),t.state==="loading"||l&&f?S("calcite-scrim",null,S("span",{"aria-hidden":"true",role:"presentation",class:y.loaderAnimation})):null)}};c([u()],b.prototype,"activeBasemap",null),c([u()],b.prototype,"disabled",void 0),c([u()],b.prototype,"headingLevel",void 0),c([u()],b.prototype,"iconClass",void 0),c([u()],b.prototype,"label",null),c([u(),ut("esri/widgets/BasemapGallery/t9n/BasemapGallery")],b.prototype,"messages",void 0),c([u()],b.prototype,"source",null),c([u()],b.prototype,"view",null),c([u()],b.prototype,"viewModel",void 0),c([_t()],b.prototype,"_handleClick",null),b=c([W("esri.widgets.BasemapGallery")],b);const Ss=b;export{Ss as default};
